# DNS概念设计与协议规范

## 文档概述

本文档基于RFC1034和RFC1035标准，详细描述DNS（域名系统）的理论概念、协议规范和设计原理。这是一份专注于DNS理论基础的技术文档。

## 目录

1. [DNS系统概述](#1-dns系统概述)
2. [DNS命名空间和域名结构](#2-dns命名空间和域名结构)
3. [DNS工作原理](#3-dns工作原理)
4. [DNS记录类型](#4-dns记录类型)
5. [RFC1034核心规范](#5-rfc1034核心规范)
6. [域名空间设计](#6-域名空间设计)
7. [名称服务器架构](#7-名称服务器架构)
8. [解析器设计](#8-解析器设计)
9. [RFC1035协议规范](#9-rfc1035协议规范)
10. [DNS消息格式](#10-dns消息格式)
11. [消息字段详解](#11-消息字段详解)
12. [协议传输机制](#12-协议传输机制)
13. [DNS安全机制](#13-dns安全机制)
14. [现代DNS扩展](#14-现代dns扩展)

---

## 1. DNS系统概述

> 基于RFC1034第1-2章内容

### 1.1 DNS的历史背景

DNS（Domain Name System，域名系统）的发展源于早期互联网的增长需求：

- **HOSTS.TXT文件问题**：早期主机名到地址的映射由网络信息中心（NIC）在单个文件（HOSTS.TXT）中维护，所有主机通过FTP获取。随着网络规模的扩大，这种方式的带宽消耗与主机数量的平方成正比。

- **网络结构变化**：原始ARPANET的分时主机正被工作站的本地网络所取代。本地组织需要管理自己的名称和地址，但必须等待NIC更改HOSTS.TXT才能使更改对整个互联网可见。

- **应用程序需求**：互联网上的应用程序变得更加复杂，需要通用的名称服务。

### 1.2 DNS设计目标

DNS系统的设计目标包括：

1. **一致的名称空间**：提供用于引用资源的一致名称空间，避免包含网络标识符、地址、路由等信息的临时编码问题。

2. **分布式维护**：由于数据库的庞大规模和更新频率，必须以分布式方式维护，并使用本地缓存来提高性能。

3. **可控的权衡**：在获取数据的成本、更新速度和缓存准确性之间的权衡应由数据源控制。

4. **通用性**：该系统应该是通用的，不仅限于单一应用程序。能够使用名称检索主机地址、邮箱数据和其他未确定的信息。

5. **协议独立性**：能够在不同的协议族中使用相同的名称空间，支持不同的管理方式。

6. **传输独立性**：名称服务器事务应独立于承载它们的通信系统。

7. **广泛适用性**：系统应该可以在从个人计算机到大型分时主机的广泛主机能力范围内使用。

### 1.3 DNS的基本组成元素

DNS系统由以下几个核心元素组成：

- **域名空间**：树状结构的命名空间
- **资源记录**：存储域名相关信息的数据结构
- **名称服务器**：存储和提供域名信息的服务器
- **解析器**：客户端程序，用于查询域名信息

### 1.4 DNS的使用模式假设

基于RFC1034第2.3章，DNS系统设计基于以下使用模式假设：

1. **数据库大小**：总数据库的大小最初与使用系统的主机数量成正比，但最终会增长到与这些主机上的用户数量成正比。

2. **数据变化频率**：系统中的大多数数据将变化非常缓慢（如邮箱绑定、主机地址），但系统应该能够处理变化更快的子集（以秒或分钟为单位）。

3. **管理边界**：用于分配数据库责任的管理边界通常对应于拥有一个或多个主机的组织。

4. **信任关系**：域系统的客户端应该能够识别他们在接受域系统外部名称服务器推荐之前更喜欢使用的可信名称服务器。

5. **一致性要求**：访问信息比即时更新或一致性保证更重要。更新过程允许更新通过域系统的用户传播，而不是保证所有副本同时更新。

---

## 2. DNS命名空间和域名结构

> 基于RFC1034第3章内容

### 2.1 命名空间规范和术语

#### 2.1.1 树状结构

DNS命名空间是一个**树状结构**。树上的每个节点和叶子都对应一个资源集合（可能为空）。DNS系统不区分内部节点和叶子节点的用途，本文统一使用"节点"来指代两者。

#### 2.1.2 标签规则

每个节点都有一个**标签(label)**，长度为0到63个八位字节。兄弟节点不能有相同的标签，但非兄弟节点可以使用相同的标签。有一个保留标签：**空标签**（零长度），专门用于根节点。

#### 2.1.3 域名构成

节点的域名是从该节点到树根路径上所有标签的列表。按照惯例，组成域名的标签从左到右打印或读取，从最具体的（最低级，距离根最远）到最不具体的（最高级，最接近根）。

**示例域名**：`poneria.ISI.EDU.`

这个域名从左到右表示：
- `poneria`：最具体的标签（主机名）
- `ISI`：中级标签（组织）
- `EDU`：高级标签（顶级域）
- `.`：根标签（隐含）

#### 2.1.4 内部表示

在程序内部，域名应该表示为标签序列，其中每个标签由一个长度八位字节后跟一个八位字节字符串组成。由于所有域名都以根结尾（根的标签为空字符串），这些内部表示可以使用长度字节零来终止域名。

#### 2.1.5 大小写规则

按照惯例，域名可以用任意大小写存储，但所有当前域功能的域名比较都以**大小写不敏感**的方式进行，假设使用ASCII字符集。这意味着您可以创建标签为"A"或"a"的节点，但不能两者都作为兄弟节点；您可以使用"a"或"A"来引用任一节点。

### 2.2 绝对名称与相对名称

#### 2.2.1 绝对域名

当用户需要键入域名时，会省略每个标签的长度，标签之间用点（"."）分隔。由于完整的域名以根标签结尾，这导致打印形式以点结尾。

**绝对域名示例**：`poneria.ISI.EDU.`
- 这是一个完整的域名（通常称为"绝对"）
- 以点结尾表示完整路径到根

#### 2.2.2 相对域名

**相对域名示例**：`poneria`
- 这是域名的起始标签，不完整
- 应该由本地软件使用本地域知识来完成
- 例如，在ISI.EDU域中使用"poneria"

相对名称要么相对于一个已知的起点，要么相对于用作搜索列表的域列表。相对名称主要出现在：
1. **用户界面**：解释因实现而异
2. **主文件**：相对于单一起始域名

### 2.3 域名限制

为了简化实现，表示域名的总八位字节数（即所有标签八位字节和标签长度的总和）限制为**255个八位字节**。

### 2.4 域和子域关系

**域的定义**：域由域名标识，包含在指定域的域名处或其下方的域名空间部分。

**子域关系**：如果一个域包含在另一个域中，则它是另一个域的子域。这种关系可以通过查看子域的名称是否以包含域的名称结尾来测试。

**示例**：`A.B.C.D`是以下域的子域：
- `B.C.D`
- `C.D`  
- `D`
- `""`（根域）

### 2.5 首选名称语法

#### 2.5.1 语法规则

为了与更多应用程序兼容，建议使用以下语法：

```
<domain> ::= <subdomain> | " "
<subdomain> ::= <label> | <subdomain> "." <label>
<label> ::= <letter> [ [ <ldh-str> ] <let-dig> ]
<ldh-str> ::= <let-dig-hyp> | <let-dig-hyp> <ldh-str>
<let-dig-hyp> ::= <let-dig> | "-"
<let-dig> ::= <letter> | <digit>
<letter> ::= A-Z 和 a-z（52个字母）
<digit> ::= 0-9（10个数字）
```

#### 2.5.2 标签限制

标签必须遵循ARPANET主机名规则：
- **开始**：必须以字母开头
- **结尾**：必须以字母或数字结尾
- **内部字符**：只能包含字母、数字和连字符
- **长度限制**：标签不得超过63个字符

**有效示例**：
- `A.ISI.EDU`
- `XX.LCS.MIT.EDU`
- `SRI-NIC.ARPA`

### 2.6 示例命名空间

以下是当前域名空间的一部分示例：

```
                                   |
                                   |
             +---------------------+------------------+
             |                     |                  |
            MIL                   EDU                ARPA
             |                     |                  |
             |                     |                  |
       +-----+-----+               |     +------+-----+-----+
       |     |     |               |     |      |           |
      BRL  NOSC  DARPA             |  IN-ADDR  SRI-NIC     ACC
                                   |
       +--------+------------------+---------------+--------+
       |        |                  |               |        |
      UCI      MIT                 |              UDEL     YALE
                |                 ISI
                |                  |
            +---+---+              |
            |       |              |
           LCS  ACHILLES  +--+-----+-----+--------+
            |             |  |     |     |        |
            XX            A  C   VAXA  VENERA Mockapetris
```

在这个示例中：
- 根域有三个直接子域：MIL、EDU和ARPA
- LCS.MIT.EDU域有一个直接子域XX.LCS.MIT.EDU
- 所有叶子节点也都是域

---

## 3. DNS工作原理

> 基于RFC1034第2.4章内容

### 3.1 DNS的三大组件

DNS系统由三个主要组件构成：

#### 3.1.1 域名空间和资源记录 (DOMAIN NAME SPACE and RESOURCE RECORDS)

这是树状结构命名空间和与名称相关联的数据的规范。从概念上讲，域名空间树的每个节点和叶子都命名一组信息，查询操作试图从特定集合中提取特定类型的信息。

**查询机制**：
- 查询指定感兴趣的域名
- 描述所需的资源信息类型
- 例如：互联网使用某些域名来标识主机，地址资源查询返回互联网主机地址

#### 3.1.2 名称服务器 (NAME SERVERS)

名称服务器是保存有关域树结构和集合信息的服务器程序。

**功能特性**：
- 可以缓存域树任何部分的结构或集合信息
- 通常对域空间的子集拥有完整信息
- 拥有指向其他名称服务器的指针，可用于获取域树任何部分的信息
- 知道自己拥有完整信息的域树部分

**权威性概念**：
- 名称服务器对命名空间的某些部分具有**权威性(AUTHORITY)**
- 权威信息组织成称为**区域(ZONES)**的单元
- 这些区域可以自动分发到为区域中的数据提供冗余服务的名称服务器

#### 3.1.3 解析器 (RESOLVERS)

解析器是响应客户端请求从名称服务器提取信息的程序。

**核心能力**：
- 必须能够访问至少一个名称服务器
- 使用名称服务器的信息直接回答查询，或使用对其他名称服务器的引用来追求查询
- 通常是用户程序可以直接访问的系统例程
- 解析器和用户程序之间不需要协议

### 3.2 DNS的三层视图

这三个组件大致对应于域系统的三层或三个视图：

#### 3.2.1 用户视图

**用户角度**：
- 通过对本地解析器的简单过程或操作系统调用来访问域系统
- 域空间由单一树组成
- 用户可以从树的任何部分请求信息

#### 3.2.2 解析器视图

**解析器角度**：
- 域系统由未知数量的名称服务器组成
- 每个名称服务器都有整个域树数据的一个或多个片段
- 解析器将这些数据库中的每一个都视为基本静态的

#### 3.2.3 名称服务器视图

**名称服务器角度**：
- 域系统由称为区域的单独本地信息集组成
- 名称服务器拥有某些区域的本地副本
- 必须定期从本地文件或外部名称服务器中的主副本刷新其区域
- 必须同时处理来自解析器的查询

### 3.3 DNS查询处理流程

#### 3.3.1 基本查询流程

1. **用户发起查询**：用户程序调用解析器，请求特定域名的特定资源类型
2. **解析器处理**：解析器检查本地缓存，如果没有找到则向名称服务器查询
3. **名称服务器响应**：名称服务器返回答案或指向其他名称服务器的引用
4. **递归或迭代查询**：解析器根据需要继续查询，直到获得最终答案
5. **返回结果**：解析器将结果返回给用户程序

#### 3.3.2 查询类型

**递归查询**：
- 解析器要求名称服务器完成完整的查询处理
- 名称服务器负责获取最终答案

**迭代查询**：
- 名称服务器返回最佳可用答案或引用
- 解析器负责继续查询过程

#### 3.3.3 缓存机制

**目的**：提高性能，减少网络流量和查询延迟

**工作原理**：
- 解析器和名称服务器都可以缓存查询结果
- 缓存数据有生存时间（TTL）限制
- 过期数据会被丢弃，确保信息的时效性

### 3.4 DNS系统的分布式特性

#### 3.4.1 分布式数据库

DNS本质上是一个分布式数据库：
- 没有单一的中央数据库
- 数据分布在全球数千台名称服务器上
- 每台服务器只负责命名空间的一部分

#### 3.4.2 容错性

**冗余设计**：
- 每个区域通常有多个权威名称服务器
- 如果一台服务器不可用，其他服务器可以提供服务

**缓存机制**：
- 即使权威服务器暂时不可用，缓存的数据仍然可以提供服务
- 降低了系统对单点故障的敏感性

#### 3.4.3 可扩展性

**层次结构**：
- 树状结构自然支持系统扩展
- 新域可以轻松添加而不影响现有结构

**负载分布**：
- 查询负载分布在多个服务器上
- 本地缓存减少了对根服务器的查询压力

---

## 4. DNS记录类型

> 基于RFC1034第3.6章内容

### 4.1 资源记录概述

域名标识一个节点。每个节点都有一组资源信息，这些信息可能为空。与特定名称关联的资源信息集合由单独的**资源记录(Resource Records, RRs)**组成。集合中RR的顺序不重要，名称服务器、解析器或DNS的其他部分无需保留此顺序。

### 4.2 资源记录结构

每个资源记录都包含以下字段：

#### 4.2.1 Owner（所有者）
找到RR的域名。

#### 4.2.2 Type（类型）
指定此资源记录中资源类型的编码16位值。类型引用抽象资源。

#### 4.2.3 Class（类别）
标识协议族或协议实例的编码16位值。

#### 4.2.4 TTL（生存时间）
RR的生存时间。这是一个32位整数，单位为秒，主要由解析器在缓存RR时使用。TTL描述RR在被丢弃之前可以缓存多长时间。

#### 4.2.5 RDATA（资源数据）
取决于类型和有时类别的数据，描述资源。

### 4.3 主要记录类型

基于RFC1034，DNS系统使用以下记录类型：

#### 4.3.1 A记录 - 主机地址
**用途**：存储主机的IP地址

**数据格式**：
- **IN类别**：32位IP地址
- **CH类别**：域名后跟16位八进制Chaos地址

**示例**：
```
www.example.com.    IN  A   192.0.2.1
```

#### 4.3.2 CNAME记录 - 规范名称
**用途**：标识别名的规范名称

**数据格式**：域名

**示例**：
```
alias.example.com.  IN  CNAME  www.example.com.
```

#### 4.3.3 HINFO记录 - 主机信息
**用途**：标识主机使用的CPU和操作系统

**数据格式**：两个字符串，分别表示CPU类型和操作系统

**示例**：
```
host.example.com.   IN  HINFO  "Intel x86" "Linux"
```

#### 4.3.4 MX记录 - 邮件交换
**用途**：标识域的邮件交换器

**数据格式**：
- 16位优先级值（数值越低优先级越高）
- 愿意为所有者域充当邮件交换器的主机名

**示例**：
```
example.com.        IN  MX  10  mail.example.com.
```

#### 4.3.5 NS记录 - 名称服务器
**用途**：指定域的权威名称服务器

**数据格式**：主机名

**示例**：
```
example.com.        IN  NS  ns1.example.com.
```

#### 4.3.6 PTR记录 - 指针记录
**用途**：指向域名空间其他部分的指针（主要用于反向解析）

**数据格式**：域名

**示例**：
```
1.2.0.192.in-addr.arpa.  IN  PTR  www.example.com.
```

#### 4.3.7 SOA记录 - 授权开始
**用途**：标识区域权威的开始

**数据格式**：包含多个字段的复杂结构
- 主名称服务器
- 负责人邮箱
- 序列号
- 刷新间隔
- 重试间隔
- 过期时间
- 最小TTL

**示例**：
```
example.com.  IN  SOA  ns1.example.com. admin.example.com. (
                       2024123001  ; 序列号
                       3600        ; 刷新间隔
                       1800        ; 重试间隔
                       1209600     ; 过期时间
                       86400       ; 最小TTL
                       )
```

#### 4.3.8 TXT记录 - 文本记录
**用途**：存储任意文本信息

**数据格式**：文本字符串

**示例**：
```
example.com.        IN  TXT  "v=spf1 include:_spf.example.com ~all"
```

### 4.4 记录类别

DNS支持多个协议类别：

#### 4.4.1 IN类别 - 互联网系统
最常用的类别，用于互联网协议。

#### 4.4.2 CH类别 - Chaos系统
用于Chaos网络协议。

### 4.5 TTL字段的意义

TTL字段表示RR可以在缓存中保留的时间限制。此限制不适用于区域中的权威数据；权威数据也会超时，但通过区域的刷新策略进行。

**TTL策略**：
- TTL由数据来源区域的管理员分配
- 虽然可以使用短TTL来最小化缓存，零TTL禁止缓存
- 互联网性能的现实表明，对于典型主机，这些时间应该以天为单位
- 如果可以预期更改，可以在更改之前减少TTL以最小化更改期间的不一致性
- 更改后可以将TTL增加回其以前的值

### 4.6 RDATA数据格式

RDATA部分的数据以二进制字符串和域名的组合形式携带。域名经常用作DNS中其他数据的"指针"。

### 4.7 资源记录的文本表示

#### 4.7.1 表示格式

RR在DNS协议的数据包中以二进制形式表示，通常在名称服务器或解析器中以高度编码的形式存储。为了显示RR的内容，采用类似于主文件中使用的样式。

#### 4.7.2 格式规则

- 行的开头给出RR的所有者
- 如果行以空白开头，则假定所有者与前一个RR相同
- 为了可读性，通常包含空白行
- 在所有者之后，列出RR的TTL、类型和类别
- 类别和类型使用上面定义的助记符
- TTL是类型字段之前的整数
- 为了避免解析中的歧义，类型和类别助记符是不相交的
- TTL是整数，类型助记符总是最后出现
- 为了清楚起见，示例中经常省略IN类别和TTL值

**示例格式**：
```
owner               TTL  class  type   RDATA
www.example.com.    3600 IN     A      192.0.2.1
                    3600 IN     A      192.0.2.2
mail.example.com.   3600 IN     MX     10 smtp.example.com.
```

---

## 5. RFC1034核心规范

> 基于RFC1034第4-5章内容

### 5.1 查询类型和类别

#### 5.1.1 查询类型 (QTYPE)

除了标准的资源记录类型外，还有特殊的查询类型：

**AXFR**：特殊的区域传输查询类型
- 用于完整的区域传输
- 只能通过TCP可靠传输
- 用于主从服务器之间的数据同步

**MAILB**：匹配所有邮箱相关的RR（如MB和MG）

**\*** ：匹配所有RR类型
- 用于获取指定名称的所有资源记录
- 响应可能包含该名称的所有类型记录

#### 5.1.2 查询类别 (QCLASS)

**&lt;任何类别&gt;**：只匹配该特定类别（如IN、CH）

**\*** ：匹配所有RR类别
- 需要特殊处理权威性问题
- 由于名称服务器可能不知道域系统中所有可用的类别，对QCLASS=*查询的响应永远不能是权威性的

### 5.2 逆向查询（可选）

#### 5.2.1 逆向查询概念

名称服务器还可以支持逆向查询，将特定资源映射到拥有该资源的域名。例如：
- 标准查询：域名 → SOA RR
- 逆向查询：SOA RR → 域名

#### 5.2.2 逆向查询限制

**实现状态**：
- 在名称服务器中实现此服务是可选的
- 所有名称服务器至少必须能够理解逆向查询消息并返回未实现错误响应

**系统限制**：
- DNS无法保证逆向查询的完整性或唯一性
- 域系统按域名组织，而不是按主机地址或其他资源类型组织
- 主要用于调试和数据库维护活动

**注意事项**：
- 逆向查询可能不返回正确的TTL
- 不指示识别出的RR是否为集合中的一个
- 逆向查询返回的RR永远不应该被缓存
- 逆向查询不是将主机地址映射到主机名的可接受方法；应使用IN-ADDR.ARPA域

### 5.3 查询处理模式

#### 5.3.1 非递归模式

**特点**：
- 服务器最简单的模式
- 只使用本地信息回答查询
- 响应包含错误、答案或对其他服务器的引用
- 所有名称服务器都必须实现非递归查询

**适用场景**：
- 请求者有能力追踪引用
- 对有助于未来请求的信息感兴趣的情况

#### 5.3.2 递归模式

**特点**：
- 客户端最简单的模式
- 名称服务器充当解析器角色
- 返回错误或答案，但从不返回引用
- 在名称服务器中此服务是可选的
- 名称服务器可以选择限制可以使用递归模式的客户端

**适用场景**：
- 相对简单的请求者，缺乏使用直接答案以外任何东西的能力
- 需要跨协议或其他边界的请求
- 希望集中缓存而不是为每个客户端单独缓存的网络

#### 5.3.3 递归协商机制

通过查询和响应消息中的两个位来协商递归模式的使用：

**RA位（递归可用）**：
- 由名称服务器在所有响应中设置或清除
- 如果名称服务器愿意为客户端提供递归服务则为真
- 信号可用性而不是使用

**RD位（请求递归）**：
- 查询包含此位
- 指定请求者是否希望对此查询进行递归服务
- 客户端可以从任何名称服务器请求递归服务

---

## 6. 域名空间设计

> 基于RFC1034第4.2章内容

### 6.1 数据库分区机制

#### 6.1.1 域数据库分区方式

域数据库通过两种方式进行分区：

**按类别分区**：
- 任何类别的数据库都与所有其他类别分开组织、委托和维护
- 按照惯例，所有类别的名称空间都相同
- 不同的类别可以看作是并行命名空间树的数组
- 附加到节点的数据对于这些不同的并行类别将有所不同

**按"切割"分区**：
- 在名称空间中任意两个相邻节点之间可以进行"切割"
- 切割后，每组连接的名称空间是一个单独的区域
- 区域对连接区域中的所有名称具有权威性

#### 6.1.2 区域的基本特性

**连接性**：
- 每个区域至少有一个节点，因此有一个域名是其权威的
- 特定区域中的所有节点都是连接的

**层次性**：
- 给定树结构，每个区域都有一个最高节点
- 最高节点比区域中任何其他节点更接近根
- 通常使用此节点的名称来标识区域

**管理控制**：
- 数据库在特定组织希望控制子树的地方进行分区
- 组织控制自己的区域后，可以：
  - 单方面更改区域中的数据
  - 增长连接到区域的新树部分
  - 删除现有节点
  - 在其区域下委托新的子区域

### 6.2 区域数据的四个主要部分

#### 6.2.1 区域内权威数据
- 区域内所有节点的权威数据
- 从区域顶部节点到叶节点或区域底部边缘切割上方节点的所有RR

#### 6.2.2 区域顶部节点定义数据
- 描述区域顶部节点的RR（可视为权威数据的一部分）
- 两种类型的RR：
  - **名称服务器RR**：列出区域的所有服务器，每个RR一个
  - **单个SOA RR**：描述区域管理参数

#### 6.2.3 委托子区域描述数据
- 描述委托子区域的NS RR，即围绕区域底部的切割
- 由于切割在节点之间，这些RR不是区域权威数据的一部分
- 应该与子区域顶部节点中的对应RR完全相同

#### 6.2.4 访问子区域名称服务器的数据
- 允许访问子区域名称服务器的数据（有时称为"胶水"数据）
- 不是权威数据的一部分，是服务器的地址RR
- 只有当名称服务器的名称在切割"下方"时才必要
- 仅用作引用响应的一部分

### 6.3 区域传输和维护

#### 6.3.1 区域冗余要求

**最低要求**：
- 通过管理要求，要求每个区域至少在两台服务器上可用
- 许多区域具有比此更多的冗余性
- 确保在主机或通信链路故障时区域的可用性

#### 6.3.2 主从服务器模型

**主服务器（Primary）**：
- 区域的主要或权威服务器
- 在主服务器上协调更改
- 通常通过编辑区域的主文件进行更改
- 编辑后，管理员信号主服务器加载新区域

**从服务器（Secondary）**：
- 区域的非主服务器
- 定期检查更改（可选择间隔）
- 发生更改时获取新区域副本

#### 6.3.3 区域同步机制

**更改检测**：
- 从服务器通过检查区域SOA的SERIAL字段来检测更改
- 对区域进行任何更改时，SOA中的SERIAL字段总是会提前
- 序列号使用序列空间算术进行比较

**同步参数**：
- **REFRESH**：从服务器等待的秒数，然后检查主服务器的新序列号
- **RETRY**：如果检查无法完成，每隔RETRY秒开始新检查
- **EXPIRE**：如果从服务器在EXPIRE间隔内无法执行序列检查，必须假设其区域副本已过时并丢弃它

**区域传输过程**：
- 当轮询显示区域已更改时，从服务器必须通过AXFR请求区域传输
- AXFR必须使用TCP或其他可靠协议
- 第一条和最后一条消息必须包含区域的顶部权威节点的数据
- 中间消息携带区域的所有其他RR

### 6.4 委托和管理

#### 6.4.1 委托建立过程

**步骤1：确定父区域**
- 当组织想要控制自己的域时，第一步是确定正确的父区域
- 获得父区域所有者同意委托控制

**步骤2：选择子区域名称**
- 选择新子区域的正确名称
- 遵循相关的管理指导原则

**步骤3：演示冗余支持**
- 新所有者应需要演示冗余名称服务器支持
- 区域的服务器不需要驻留在该域中有名称的主机中
- 服务器广泛分布通常使区域对互联网更可访问

**步骤4：添加委托记录**
- 作为最后的安装步骤，应将委托NS RR和胶水RR添加到父区域
- 两个区域的管理员应确保标记切割两侧的NS和胶水RR保持一致

---

## 7. 名称服务器架构

> 基于RFC1034第4.3章内容

### 7.1 名称服务器的核心功能

#### 7.1.1 基本职责

名称服务器是组成域数据库的信息存储库。其基本任务是：
- **响应查询**：使用其区域中的数据回答查询
- **简单操作**：响应始终可以仅使用本地数据生成
- **提供引用**：包含答案或对"更接近"所需信息的其他名称服务器的引用

#### 7.1.2 权威性标记

名称服务器将其查询响应标记为：
- **权威性数据**：来自服务器的权威区域
- **非权威性数据**：来自缓存的数据

### 7.2 名称服务器查询算法

#### 7.2.1 算法概述

假设RR组织在几个树结构中，每个区域一个，另一个用于缓存：

**步骤1：设置递归可用位**
- 根据名称服务器是否愿意提供递归服务设置或清除RA位
- 如果递归服务可用且通过查询中的RD位请求，转到步骤5
- 否则转到步骤2

**步骤2：查找权威区域**
- 搜索可用区域，找到QNAME的最近祖先区域
- 如果找到这样的区域，转到步骤3
- 否则转到步骤4

**步骤3：区域内匹配**
匹配过程可能以几种方式终止：

a) **完全匹配QNAME**：
   - 如果节点的数据是CNAME且QTYPE不匹配CNAME：
     - 将CNAME RR复制到响应的答案部分
     - 将QNAME更改为CNAME RR中的规范名称
     - 返回步骤1
   - 否则，将所有匹配QTYPE的RR复制到答案部分，转到步骤6

b) **遇到引用**：
   - 匹配将使我们脱离权威数据（遇到标记区域底部切割的NS RR）
   - 将子区域的NS RR复制到回复的权威部分
   - 将任何可用地址放入附加部分（使用胶水RR）
   - 转到步骤4

c) **标签匹配失败**：
   - 在某个标签处，匹配不可能（相应标签不存在）
   - 查找"*"标签是否存在
   - 如果"*"标签不存在：
     - 检查我们要查找的名称是否是查询中的原始QNAME
     - 如果是原始名称，在响应中设置权威名称错误并退出
     - 否则直接退出
   - 如果"*"标签存在：
     - 将该节点的RR与QTYPE匹配
     - 如果匹配，将它们复制到答案部分（所有者设置为QNAME）
     - 转到步骤6

**步骤4：缓存匹配**
- 开始在缓存中向下匹配
- 如果在缓存中找到QNAME，将附加到它的所有匹配QTYPE的RR复制到答案部分
- 如果没有来自权威数据的委托，从缓存中查找最佳委托
- 转到步骤6

**步骤5：递归解析**
- 使用本地解析器或其算法的副本来回答查询
- 将结果（包括任何中间CNAME）存储在响应的答案部分中

**步骤6：附加信息**
- 仅使用本地数据，尝试向查询的附加部分添加其他可能有用的RR
- 退出

#### 7.2.2 通配符处理

**通配符概念**：
- 所有者名称以标签"*"开头的RR称为通配符
- 可以视为合成RR的指令
- 满足适当条件时，名称服务器创建所有者名称等于查询名称的RR

**通配符规则**：
- 通配符的所有者名称形式为"\*.\<anydomain\>"
- \<anydomain\>不应包含其他*标签
- 应在区域的权威数据中
- 通配符可能适用于\<anydomain\>的后代，但不适用于\<anydomain\>本身
- "*"标签总是匹配至少一个完整标签

**通配符不适用的情况**：
- 查询在另一个区域中时（委托取消通配符默认值）
- 当查询名称或通配符域和查询名称之间的名称已知存在时

### 7.3 负响应缓存（可选）

#### 7.3.1 负缓存机制

DNS提供可选服务，允许名称服务器分发和解析器缓存带有TTL的负结果：
- 名称服务器可以分发TTL以及名称错误指示
- 解析器可以在TTL期间假设名称不存在，无需咨询权威数据

#### 7.3.2 SOA机制

**方法**：
- 当响应是权威性的时，名称服务器可以向响应的附加部分添加SOA RR
- SOA必须是答案部分中权威数据源区域的SOA
- SOA的MINIMUM字段控制负结果可以缓存的时间长度

**限制**：
- 名称服务器和解析器不应尝试向非权威响应的附加部分添加SOA
- 不应尝试推断权威响应中未直接说明的结果
- 此功能是可选的，尽管预期未来将成为标准协议的一部分

### 7.4 区域维护和传输

#### 7.4.1 区域管理模型

**自动区域传输模型**：
- 其中一个名称服务器是区域的主服务器或主要服务器
- 在主服务器上协调更改
- 其他非主服务器或从服务器定期检查更改
- 发生更改时获取新区域副本

#### 7.4.2 更改检测机制

**序列号比较**：
- 从服务器检查区域SOA的SERIAL字段
- 对区域进行任何更改时，SOA中的SERIAL字段总是前进
- 序列号前进可以是简单递增或基于主文件的写入日期和时间
- 序列号比较使用序列空间算术

#### 7.4.3 轮询控制参数

SOA RR中的参数控制从服务器的定期轮询：

**REFRESH**：从服务器在检查主服务器新序列号之前等待的秒数

**RETRY**：如果检查无法完成，每隔RETRY秒开始新检查

**EXPIRE**：如果从服务器在EXPIRE间隔内无法执行序列检查，必须假设其区域副本已过时并丢弃它

#### 7.4.4 区域传输过程

**AXFR请求**：
- 当轮询显示区域已更改时，从服务器必须通过AXFR请求区域传输
- AXFR可能导致错误（如拒绝），但通常由一系列响应消息回答
- 必须使用TCP或其他可靠协议

**传输格式**：
- 第一条和最后一条消息必须包含区域顶部权威节点的数据
- 中间消息携带区域的所有其他RR
- 消息流允许从服务器构建区域的副本

**传输策略**：
- 每个从服务器都需要对主服务器执行这些操作
- 也可以选择对其他从服务器执行这些操作
- 当主服务器由于主机停机或网络问题而不可用时，此策略可以改善传输过程

---

## 8. 解析器设计

> 基于RFC1034第5章内容

### 8.1 解析器概述

#### 8.1.1 解析器定义

解析器是用户程序与域名服务器之间的接口程序。在最简单的情况下：
- 解析器接收来自用户程序的请求（邮件程序、TELNET、FTP等）
- 以子程序调用、系统调用等形式接收请求
- 以与本地主机数据格式兼容的形式返回所需信息

#### 8.1.2 解析器特性

**位置特性**：
- 解析器位于请求解析器服务的程序相同机器上
- 可能需要咨询其他主机上的名称服务器

**性能特性**：
- 解析器完成时间可能变化很大，从毫秒到几秒
- 因为解析器可能需要咨询多个名称服务器
- 或者可能在本地缓存中有请求的信息

**缓存目标**：
- 通过从先前结果的缓存中回答大多数请求来消除网络延迟和名称服务器负载
- 多个进程、用户、机器等共享的缓存比非共享缓存更高效

### 8.2 客户端-解析器接口

#### 8.2.1 典型功能

解析器-客户端接口受本地主机约定影响，但典型的解析器-客户端接口有三个功能：

**1. 主机名到主机地址转换**
- 通常定义为模拟以前基于HOSTS.TXT的功能
- 给定字符串，调用者需要一个或多个32位IP地址
- 在DNS下，转换为对A类型RR的请求
- 由于DNS不保留RR的顺序，此功能可以选择对返回的地址进行排序
- 建议返回多个地址，但单个地址可能是模拟先前HOSTS.TXT服务的唯一方法

**2. 主机地址到主机名转换**
- 通常遵循以前功能的形式
- 给定32位IP地址，调用者需要字符串
- IP地址的八位字节被反转，用作名称组件，并以"IN-ADDR.ARPA"为后缀
- 使用PTR类型查询获取具有主机主要名称的RR
- 例如：对应于IP地址1.2.3.4的主机名请求查找域名"4.3.2.1.IN-ADDR.ARPA"的PTR RR

**3. 通用查找功能**
- 从DNS检索任意信息，在以前的系统中没有对应功能
- 调用者提供QNAME、QTYPE和QCLASS，需要所有匹配的RR
- 通常对所有RR数据使用DNS格式而不是本地主机格式
- 返回所有RR内容（如TTL）而不是带有本地引用约定的处理形式

#### 8.2.2 查询结果类型

当解析器执行指定功能时，通常有以下结果之一返回给客户端：

**成功结果**：
- 一个或多个提供请求数据的RR
- 解析器以适当格式返回答案

**名称错误（NE）**：
- 当引用的名称不存在时发生
- 例如，用户可能错误输入了主机名

**数据未找到错误**：
- 当引用的名称存在但适当类型的数据不存在时发生
- 例如，对邮箱名称应用主机地址功能会返回此错误

**错误合并注意事项**：
- 主机名和地址之间转换的功能可能将"名称错误"和"数据未找到"错误条件合并为单一错误返回类型
- 但通用功能不应该这样做
- 应用程序可能首先询问名称的一种信息，然后对同一名称请求其他类型的信息

#### 8.2.3 别名处理

**别名检测**：
- 在尝试解析特定请求时，解析器可能发现相关名称是别名
- 例如，当找到CNAME RR时，解析器可能发现用于主机名到地址转换的给定名称是别名
- 如果可能，别名条件应该从解析器信号传回客户端

**别名处理策略**：
- 在大多数情况下，遇到CNAME时解析器简单地在新名称处重新开始查询
- 但执行通用功能时，当CNAME RR匹配查询类型时，解析器不应追踪别名
- 这允许询问别名是否存在的查询

**特殊条件**：
- 应避免多级别别名（效率低），但不应作为错误信号
- 应捕获别名循环和指向不存在名称的别名，并将错误条件传回客户端

#### 8.2.4 临时故障

**故障原因**：
- 由于链路故障或网关问题，解析器与网络其余部分分离
- 特定域的所有服务器同时故障或不可用（较少见）

**处理原则**：
- 此类条件不应向应用程序信号为名称或数据不存在错误
- 这种行为对人类很烦人，当邮件系统使用DNS时可能造成严重破坏

**推荐解决方案**：
- 始终将临时故障作为解析器功能的可能结果之一
- 即使这可能使现有HOSTS.TXT功能的模拟更困难

### 8.3 解析器内部结构

#### 8.3.1 存根解析器

**概念**：
- 实现解析器的一种选择是将解析功能移出本地机器
- 移入支持递归查询的名称服务器中

**优势**：
- 可以在缺乏执行解析器功能资源的PC中提供域服务的简便方法
- 可以为整个本地网络或组织集中缓存

**要求**：
- 剩余的存根只需要将执行递归请求的名称服务器地址列表
- 此类型解析器可能需要配置文件中的信息
- 用户需要验证列出的服务器将执行递归服务

**缺点**：
- 由于递归请求可能需要任意时间执行，存根可能难以优化重传间隔
- 如果过于热情的存根将重传解释为新请求，名称服务器可能容易过载
- 使用TCP可能是答案，但TCP可能对主机能力施加类似于真实解析器的负担

#### 8.3.2 解析器算法数据结构

解析器算法假设所有功能都已转换为通用查找功能，并使用以下数据结构：

**SNAME**：我们正在搜索的域名

**STYPE**：搜索请求的QTYPE

**SCLASS**：搜索请求的QCLASS

**SLIST**：
- 描述名称服务器和解析器当前尝试查询的区域的结构
- 跟踪解析器当前关于哪些名称服务器持有所需信息的最佳猜测
- 包括区域名称等效、区域的已知名称服务器、名称服务器的已知地址
- 历史信息，可用于建议哪个服务器可能是下一个尝试的最佳服务器

**SBELT**：
- 与SLIST相同形式的"安全带"结构
- 从配置文件初始化
- 列出解析器没有任何本地信息指导名称服务器选择时应使用的服务器
- 匹配计数将为-1，表示没有已知匹配的标签

**CACHE**：
- 存储先前响应结果的结构
- 由于解析器负责丢弃TTL已过期的旧RR
- 大多数实现在RR存储在缓存中时将到达RR中指定的间隔转换为某种绝对时间

#### 8.3.3 解析器算法

**顶级算法四个步骤**：

**步骤1**：查看答案是否在本地信息中，如果是则返回给客户端

**步骤2**：找到要询问的最佳服务器

**步骤3**：向它们发送查询，直到一个返回响应

**步骤4**：分析响应，以下之一：
- a) 如果响应回答问题或包含名称错误，缓存数据并返回给客户端
- b) 如果响应包含对其他服务器的更好委托，缓存委托信息并转到步骤2
- c) 如果响应显示CNAME且不是答案本身，缓存CNAME，将SNAME更改为CNAME RR中的规范名称并转到步骤1
- d) 如果响应显示服务器故障或其他奇异内容，从SLIST中删除服务器并返回步骤3

**步骤详解**：

**步骤1详解**：
- 搜索缓存以获取所需数据
- 如果数据在缓存中，假设它足够好用于正常使用
- 某些解析器在用户界面有选项，强制解析器忽略缓存数据并咨询权威服务器
- 不建议作为默认设置

**步骤2详解**：
- 寻找名称服务器询问所需数据
- 一般策略是寻找本地可用的名称服务器RR
- 从SNAME开始，然后是SNAME的父域名、祖父域名等，向根方向
- 将名称复制到SLIST中，使用本地数据设置其地址

**步骤3-4详解**：
- 发送查询并分析响应
- 根据响应类型采取不同行动
- 更新缓存和数据结构
- 继续解析过程直到获得最终答案或遇到错误

---

## 9. RFC1035协议规范

> 基于RFC1035第3-4章内容

### 9.1 标准资源记录定义

RFC1035为所有类别定义了一组标准的资源记录，确保了DNS的互操作性。

#### 9.1.1 跨类别通用记录

- **NS, SOA, CNAME, PTR**：这些记录在所有类别中使用，并且格式相同
- **RDATA格式**：由于它们的RDATA格式是已知的，这些RR的RDATA部分中的所有域名都可以被压缩

#### 9.1.2 `<domain-name>`表示法
- 表示为一系列标签，并以零长度标签终止

#### 9.1.3 `<character-string>`表示法
- 单个长度八位字节，后跟该数量的字符
- 被视为二进制信息，长度最多可达256个字符（包括长度八位字节）

### 9.2 RDATA格式详解

#### 9.2.1 CNAME RDATA格式
- **内容**：一个`<domain-name>`，指定所有者的规范或主名称
- **处理**：CNAME RR不引起额外的节处理，但名称服务器在某些情况下可能会选择在规范名称处重新开始查询

#### 9.2.2 MX RDATA格式
- **内容**：
  - **PREFERENCE**：一个16位整数，指定此RR在同一所有者中其他RR中的优先级（值越低越优先）
  - **EXCHANGE**：一个`<domain-name>`，指定愿意充当所有者名称邮件交换器的主机
- **处理**：MX记录引起对EXCHANGE指定主机的A类型附加节处理

#### 9.2.3 NS RDATA格式
- **内容**：一个`<domain-name>`，指定应为指定类别和域的权威主机
- **处理**：NS记录引起常规附加节处理以定位A类型记录，并在引用中使用时，会对其所在区域进行特殊搜索以获取胶水信息

#### 9.2.4 PTR RDATA格式
- **内容**：一个`<domain-name>`，指向域名空间中的某个位置
- **处理**：PTR记录不引起额外的节处理。用于特殊域中指向域空间中的其他位置

#### 9.2.5 SOA RDATA格式
- **MNAME**：区域原始或主要数据源的名称服务器的`<domain-name>`
- **RNAME**：指定负责此区域人员邮箱的`<domain-name>`
- **SERIAL**：区域原始副本的无符号32位版本号
- **REFRESH**：刷新区域前的时间间隔（秒）
- **RETRY**：失败刷新重试前应经过的时间间隔（秒）
- **EXPIRE**：区域不再具有权威性前可经过的时间间隔上限（秒）
- **MINIMUM**：从此区域导出的任何RR应具有的无符号32位最小TTL

### 9.3 IN-ADDR.ARPA逆向解析域

- **目的**：支持网关定位和互联网地址到主机的映射，提供一种保证执行主机地址到主机名映射的方法
- **结构**：域从IN-ADDR.ARPA开始，具有遵循互联网寻址结构的子结构
- **表示**：IP地址的八位字节被反转，用作名称组件。例如，地址10.2.0.52的数据位于域名52.0.2.10.IN-ADDR.ARPA处

### 9.4 整体消息格式

DNS协议内的所有通信都以一种称为**消息**的单一格式进行。消息的顶层格式分为5个部分：

```
+---------------------+
|        Header       |
+---------------------+
|       Question      |
+---------------------+
|        Answer       |
+---------------------+
|       Authority     |
+---------------------+
|       Additional    |
+---------------------+
```

- **Header（头部）**：始终存在。包含指定其余部分哪些存在以及消息是查询还是响应的字段
- **Question（问题）**：包含描述向名称服务器提出的问题的字段
- **Answer（答案）**：包含回答问题的RR
- **Authority（权威）**：包含指向权威名称服务器的RR
- **Additional（附加）**：包含与查询相关但不是严格回答问题的RR

---

## 10. DNS消息格式

> 基于RFC1035第4.1章内容

### 10.1 消息头部格式

消息头部包含以下字段，用于控制消息内容和处理方式：

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      ID                       |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

### 10.2 问题部分格式

问题部分用于携带查询中的"问题"，即定义所询问内容的参数。该部分包含QDCOUNT（通常为1）个条目，每个条目格式如下：

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                     QNAME                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QTYPE                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QCLASS                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

### 10.3 资源记录格式

答案、权威和附加部分都共享相同的格式：可变数量的资源记录，记录数量在头部的相应计数字段中指定。每个资源记录格式如下：

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                                               /
/                      NAME                     /
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TYPE                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     CLASS                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TTL                      |
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                   RDLENGTH                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|
/                     RDATA                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

- **NAME**：此资源记录所属的域名
- **TYPE**：包含RR类型代码之一的两个八位字节
- **CLASS**：指定RDATA字段中数据类别的两个八位字节
- **TTL**：32位无符号整数，指定资源记录在被丢弃前可被缓存的时间间隔（秒）
- **RDLENGTH**：无符号16位整数，指定RDATA字段的长度（八位字节）
- **RDATA**：描述资源的可变长度八位字节字符串，格式根据RR的TYPE和CLASS而变化

---

## 11. 消息字段详解

> 基于RFC1035第4.1.1 - 4.1.3章内容

### 11.1 头部字段详解

- **ID (16位)**: 由生成查询的程序分配的标识符，用于匹配响应和查询。
- **QR (1位)**: 0表示查询，1表示响应。
- **Opcode (4位)**: 查询类型，由发起者设置并复制到响应中。
  - 0: 标准查询 (QUERY)
  - 1: 逆向查询 (IQUERY)
  - 2: 服务器状态请求 (STATUS)
  - 3-15: 保留
- **AA (1位)**: 权威答案。在响应中有效，表示响应的名称服务器是问题部分域名的权威。
- **TC (1位)**: 截断。表示由于长度超过传输通道允许的长度，此消息被截断。
- **RD (1位)**: 请求递归。在查询中设置，指示名称服务器递归地处理查询。
- **RA (1位)**: 递归可用。在响应中设置或清除，表示名称服务器中是否支持递归查询。
- **Z (3位)**: 保留供将来使用，必须为零。
- **RCODE (4位)**: 响应码，在响应中设置。
  - 0: 无错误
  - 1: 格式错误 (服务器无法解释查询)
  - 2: 服务器故障 (服务器问题导致无法处理)
  - 3: 名称错误 (仅对权威服务器有意义，表示查询引用的域名不存在)
  - 4: 未实现 (服务器不支持请求的查询类型)
  - 5: 拒绝 (策略原因拒绝操作)
  - 6-15: 保留
- **QDCOUNT (16位)**: 问题部分中的条目数。
- **ANCOUNT (16位)**: 答案部分中的资源记录数。
- **NSCOUNT (16位)**: 权威记录部分中的名称服务器资源记录数。
- **ARCOUNT (16位)**: 附加记录部分中的资源记录数。

### 11.2 问题部分字段详解

- **QNAME**: 一个域名，表示为标签序列，每个标签由一个长度八位字节后跟该数量的八位字节组成。以根的空标签的零长度八位字节终止。
- **QTYPE**: 两个八位字节的代码，指定查询的类型。
- **QCLASS**: 两个八位字节的代码，指定查询的类别（例如，IN表示互联网）。

### 11.3 资源记录字段详解

- **NAME**: 此资源记录所属的域名。
- **TYPE**: 两个八位字节，包含RR类型代码之一。
- **CLASS**: 两个八位字节，指定RDATA字段中数据的类别。
- **TTL**: 32位无符号整数，指定RR在被丢弃前可缓存的时间（秒）。零值表示RR只能用于当前事务，不应缓存。
- **RDLENGTH**: 无符号16位整数，指定RDATA字段的长度（八位字节）。
- **RDATA**: 可变长度的八位字节字符串，描述资源。格式根据RR的TYPE和CLASS而变化。

---

## 12. 协议传输机制

> 基于RFC1035第4.1.4, 4.2章内容

### 12.1 消息压缩机制

为了减小消息大小，DNS系统利用压缩方案消除消息中域名的重复。

#### 12.1.1 指针格式

- 整个域名或域名末尾的标签列表被替换为指向先前出现的相同名称的指针
- 指针采用两个八位字节序列的形式：

```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
| 1  1|                OFFSET                   |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

- **前两位为1**：这允许指针与标签区分开，因为标签必须以两位零开始（标签限制为63个八位字节或更少）
- **OFFSET字段**：指定从消息开始（即域头部ID字段的第一个八位字节）的偏移量

#### 12.1.2 压缩表示法

压缩方案允许消息中的域名表示为以下之一：
- 以零八位字节结尾的标签序列
- 一个指针
- 以指针结尾的标签序列

#### 12.1.3 压缩使用规则

- 指针只能用于域名格式不特定于类别的出现
- 如果域名包含在受长度字段限制的消息部分（如RR的RDATA部分）并使用压缩，则在长度计算中使用压缩名称的长度，而不是扩展名称的长度
- 程序可以自由选择不在其生成的消息中使用指针，但这会降低数据报容量，并可能导致截断
- **所有程序都必须能够理解包含指针的到达消息**

### 12.2 传输协议

DNS主要使用UDP和TCP作为其传输协议，各有不同的适用场景。

#### 12.2.1 UDP传输

- **标准用法**：名称服务器和解析器之间的标准查询和响应
- **消息大小限制**：当响应长度超过512字节时，服务器应将消息截断，并设置头部中的TC（截断）位
- **重传策略**：UDP是不可靠的，因此解析器负责处理重传和超时

#### 12.2.2 TCP传输

- **强制使用场景**：
  - **区域传输（AXFR）**：必须使用TCP连接，以确保数据的可靠和完整传输
- **可选使用场景**：
  - **截断响应**：当解析器收到TC位设置的UDP响应时，它应该使用TCP重新发送相同的查询，以便获取完整的响应
  - **大型查询/响应**：对于已知会产生大型响应的查询，解析器可以直接使用TCP

#### 12.2.3 端口号

- **标准端口**：DNS使用**端口53**（UDP和TCP）
- **通信模型**：客户端（解析器）从任意端口向服务器的53端口发送查询，服务器从53端口向客户端的源端口发送响应

### 12.3 服务器和解析器实现要求

#### 12.3.1 名称服务器要求

- 必须支持通过UDP接收查询
- 应该支持通过TCP接收查询
- 必须在TCP和UDP的端口53上监听
- 必须能够处理包含指针的压缩消息

#### 12.3.2 解析器要求

- 必须能够通过UDP发送查询
- 必须能够通过TCP发送查询
- 必须能够处理包含指针的压缩消息
- 必须能够处理UDP响应中的TC位，并在必要时切换到TCP

---

## 13. DNS安全机制

*（此部分将在阶段5中详细填充）*

---

## 14. 现代DNS扩展

*（此部分将在阶段5中详细填充）*

---

## 附录

### A. RFC1034关键要点摘要

**文档结构：**
- 第1章：状态说明
- 第2章：介绍（历史、设计目标、使用假设、DNS元素）
- 第3章：域名空间和资源记录
- 第4章：名称服务器
- 第5章：解析器
- 第6章：应用场景
- 第7章：参考文献

**核心概念：**
- 分层命名空间设计
- 分布式数据库管理
- 缓存机制
- 区域（Zone）概念
- 查询处理算法

### B. RFC1035关键要点摘要

**文档结构：**
- 第1章：状态说明
- 第2章：介绍（概述、配置、约定）
- 第3章：域名空间和RR定义
- 第4章：消息格式
- 第5章：主文件格式
- 第6章：名称服务器实现
- 第7章：解析器实现
- 第8章：邮件支持

**核心内容：**
- DNS消息格式规范
- 资源记录类型定义
- 查询和响应处理
- 传输协议（UDP/TCP）
- 消息压缩机制

---

## 更新日志

- **2025-06-30**：创建概念设计文档框架，完成第1章DNS系统概述
- **2025-06-30**：完成第2章DNS命名空间和域名结构，详细描述树状结构、标签规则、绝对和相对名称等概念
- **2025-06-30**：完成第3章DNS工作原理，包括三大组件、三层视图、查询流程和分布式特性
- **2025-06-30**：完成第4章DNS记录类型，详细描述各种资源记录的结构和用途
- **2025-06-30**：完成第5章RFC1034核心规范，包括查询类型、逆向查询和递归模式详解
- **2025-06-30**：完成第6章域名空间设计，涵盖数据库分区、区域管理和委托机制
- **2025-06-30**：完成第7章名称服务器架构，详述查询算法、通配符处理和区域传输
- **2025-06-30**：完成第8章解析器设计，包含客户端接口、别名处理和解析算法
- **2025-06-30**：完成第9-12章，基于RFC1035详细描述了消息格式、字段详解、压缩机制和传输协议。
- **待续**：DNS安全、现代DNS扩展及项目实现章节

---

*文档类型：概念设计 | 状态：理论部分基本完成* 