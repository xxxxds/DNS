# DNS概念设计（第二部分）

## 第13章 DNS安全机制

传统的DNS协议在设计之初并未充分考虑安全性，这使其容易受到多种攻击，如缓存投毒、DDoS攻击、中间人攻击等。为了解决这些问题，DNS安全扩展（DNSSEC）应运而生。

### 13.1 传统DNS的安全风险

1.  **DNS缓存投毒 (DNS Cache Poisoning)**
    - **描述**：攻击者向DNS解析器的缓存中注入伪造的DNS记录。当用户请求一个域名时，解析器会返回这个伪造的IP地址，将用户流量重定向到恶意服务器。
    - **原理**：利用DNS查询ID的有限空间（16位）和UDP协议的无连接特性。攻击者在合法DNS服务器响应前，发送大量伪造的响应包给解析器，如果其中某个包的查询ID匹配，解析器就会接受这个伪造响应。

2.  **DNS劫持 (DNS Hijacking)**
    - **描述**：通过篡改网络设备的DNS设置（如路由器、本地主机），或直接攻击DNS服务器，将用户的DNS请求强制转发到攻击者控制的恶意DNS服务器。
    - **后果**：导致用户访问钓鱼网站、信息泄露或服务中断。

3.  **DDoS攻击 (Distributed Denial of Service)**
    - **描述**：攻击者利用DNS服务器的开放性和递归查询功能，将其作为反射放大器，向目标服务器发送海量DNS查询流量，耗尽目标网络带宽或服务器资源。
    - **类型**：常见的有DNS反射攻击和放大攻击。

4.  **域名抢注和滥用**
    - **描述**：恶意注册与知名品牌相似的域名（Typo-squatting），用于钓鱼、传播恶意软件或进行欺诈活动。

### 13.2 DNSSEC (DNS安全扩展)

DNSSEC (Domain Name System Security Extensions) 旨在通过数据签名和公钥加密技术，为DNS查询提供数据来源的真实性和完整性验证，但它不提供机密性（即DNS查询内容本身不加密）。

- **目标**：确保用户在查询DNS时收到的应答是来自权威DNS服务器的、未经篡改的真实数据。
- **工作原理**：DNSSEC通过对DNS记录进行数字签名来工作。解析器在收到响应后，会验证这个签名，以确认数据的有效性。这个验证过程依赖于一条信任链（Chain of Trust），从根区域（.）一直到目标域名。

### 13.3 DNSSEC的核心概念和记录类型

DNSSEC引入了几个新的资源记录类型来支持其安全功能：

1.  **DNSKEY (DNS Public Key)**
    - **用途**：存储用于验证签名的公钥。一个区域（Zone）的权威服务器会发布其公钥。
    - **类型**：
        - **ZSK (Zone Signing Key)**：区域签名密钥，用于对区域内的RRset进行签名。
        - **KSK (Key Signing Key)**：密钥签名密钥，用于对DNSKEY记录本身进行签名，以增强安全性。KSK的哈希值会作为DS记录上传到父区域，从而建立信任链。

2.  **RRSIG (Resource Record Signature)**
    - **用途**：存储对某个资源记录集（RRset）的数字签名。对于区域中的每个RRset（例如，A记录、MX记录），DNSSEC都会生成一个对应的RRSIG记录。
    - **内容**：包含了签名算法、签名有效期、原始TTL等信息。

3.  **DS (Delegation Signer)**
    - **用途**：建立父区域和子区域之间的信任委托。它存储了子区域KSK的哈希值。
    - **位置**：位于父区域中，指向子区域。例如，`.com`区域中会包含`example.com`的DS记录。解析器通过验证父区域签名的DS记录，来信任子区域的KSK。

4.  **NSEC / NSEC3 (Next Secure)**
    - **用途**：解决"域名不存在"的验证问题。由于DNSSEC需要对所有数据进行签名，因此也必须有一种方式来证明某个域名或记录类型是"不存在"的。
    - **NSEC**：通过链接区域中所有已签名的域名，形成一个按字母顺序排序的循环链表。它可以明确指出请求的域名位于哪两个已存在的域名之间，从而证明其不存在。缺点是会暴露区域内的所有域名。
    - **NSEC3**：NSEC的改进版，通过对域名进行哈希处理来防止区域枚举攻击，提高了隐私性。

### 13.4 DNSSEC的信任链验证过程

DNSSEC的验证过程是一个自上而下的信任链：

1.  **根信任锚**：解析器预先配置了根区域（.）的公钥（通常是KSK），这是信任的起点。
2.  **验证DS记录**：解析器向根服务器查询目标顶级域名（如.com）的NS记录和DS记录。它使用根的公钥验证.com的DS记录的签名。
3.  **验证DNSKEY记录**：解析器向.com服务器查询目标域名（如example.com）的DS记录，并使用.com的KSK公钥（通过其DNSKEY记录获得）来验证签名。
4.  **验证RRSIG记录**：解析器最终向example.com的权威服务器查询目标记录（如www.example.com的A记录）及其RRSIG记录。它使用example.com的ZSK公钥验证A记录的签名。

如果整个链条上的所有签名都验证成功，解析器就确认收到的A记录是真实且完整的。

## 第14章 现代DNS扩展

随着互联网的发展，除了安全性，DNS在隐私保护和功能扩展方面也提出了新的需求。DoH、DoT等技术应运而生。

### 14.1 DNS over TLS (DoT) & DNS over HTTPS (DoH)

DoT和DoH的核心目标都是加密DNS查询流量，以防止被中间人窃听和篡改，保护用户隐私。

1.  **DNS over TLS (DoT)**
    - **标准**：RFC 7858
    - **工作方式**：将DNS查询和应答报文通过TLS（传输层安全性）协议进行隧道传输。
    - **端口**：使用专用的TCP端口853。
    - **优点**：标准化程度高，协议开销相对较小。
    - **缺点**：由于使用专用端口，容易被防火墙识别和封锁。

2.  **DNS over HTTPS (DoH)**
    - **标准**：RFC 8484
    - **工作方式**：将DNS查询封装在HTTPS的GET或POST请求中，发送给DoH服务器。
    - **端口**：使用标准的HTTPS端口443。
    - **优点**：流量与普通HTTPS流量混合在一起，难以被识别和过滤，抗审查能力强。
    - **缺点**：协议开销比DoT略大。

### 14.2 反向DNS查询 (Reverse DNS Lookup)

- **用途**：根据IP地址查询其对应的域名，与正向查询（域名->IP）相反。
- **实现**：通过一个特殊的顶级域`.arpa`来实现。IPv4地址的反向查询在`in-addr.arpa`域下进行，IPv6在`ip6.arpa`下。
- **格式**：需要将IP地址反转并添加后缀。例如，IP地址`192.0.2.1`的反向查询域名是`1.2.0.192.in-addr.arpa`。
- **记录类型**：使用`PTR`（Pointer）记录类型来存储IP地址到域名的映射。

### 14.3 国际化域名 (IDN - Internationalized Domain Name)

- **问题**：传统的DNS系统只支持ASCII字符。
- **解决方案**：IDN允许在域名中使用非ASCII字符（如中文、阿拉伯语等）。
- **实现机制**：通过Punycode算法，将Unicode字符的域名转换为一个等效的、只包含ASCII字符的表示形式（ACE - ASCII Compatible Encoding），以`xn--`开头。
    - **用户侧**：用户在浏览器中输入`你好.com`。
    - **客户端**：浏览器/应用程序将其转换为Punycode `xn--6qq79v.com`。
    - **DNS查询**：使用转换后的ASCII域名进行DNS查询。
    - **服务器侧**：DNS服务器处理的是`xn--6qq79v.com`。
- **标准**：IDNA (Internationalizing Domain Names in Applications) 定义了这套转换和处理机制。 