# DNS项目实现方案

本文档是`DNS-概念设计.md`的技术实现对应，详细阐述了DNS服务从系统架构到测试部署的完整方案。方案基于对RFC1034和RFC1035的深入理解，并采纳了一系列现代软件工程的最佳实践。

---

## 目录
- [1. 系统架构](#1-系统架构)
- [2. 核心类与接口设计](#2-核心类与接口设计)
- [3. 消息解析与构建](#3-消息解析与构建)
- [4. DNS查询处理流程](#4-dns查询处理流程)
- [5. 本地记录存储](#5-本地记录存储)
- [6. 缓存实现](#6-缓存实现)
- [7. 错误处理与日志](#7-错误处理与日志)
- [8. 性能优化策略](#8-性能优化策略)
- [9. 测试策略](#9-测试策略)

---

## 1. 系统架构

系统采用模块化、可扩展的分层架构，分为三层：

1.  **网络接口层 (`com.dns.server`)**: 负责处理底层网络通信。使用Java NIO实现非阻塞的UDP和TCP服务器，监听标准53端口。此层专门处理网络I/O，并将原始数据包传递给核心逻辑层。
2.  **核心逻辑层 (`com.dns.processor`)**: 系统的大脑，负责调度和执行DNS查询。包含`QueryCoordinator`（查询协调器）和`RecursiveResolver`（递归解析器）。
3.  **数据服务层 (`com.dns.cache`, `com.dns.storage`, `com.dns.client`)**: 为核心逻辑层提供数据支持，包括DNS缓存、本地记录存储和向上游服务器查询的客户端。

**关键协议特性实现**：
-   **消息压缩**: `MessageParser`和`MessageBuilder`将完全支持RFC1035中定义的指针压缩方案，以减小网络包大小。
-   **TCP报文处理**: `TcpServer`将正确处理DNS over TCP的2字节长度前缀。
-   **负缓存**: 缓存模块将支持对`NXDOMAIN`等否定响应的缓存。
-   **通配符解析**: `RecursiveResolver`将实现对`*`记录的匹配逻辑。

## 2. 核心类与接口设计

为了实现一个健壮、类型安全且易于维护的系统，核心数据模型设计如下：

-   **`Message`模型 (`com.dns.message.model`)**: 严格按照RFC1035规范，定义了`Message`, `Header`, `Question`, 和 `ResourceRecord`等核心类。
-   **`RData`强类型模型**: 这是设计的关键。`ResourceRecord`中的资源数据不再是原始的`byte[]`，而是被抽象为`RData`接口。系统为所有常见记录类型（如A, CNAME, MX, NS, SOA）提供了具体的实现类（如`AData`, `CnameData`）。这使得业务逻辑可以安全地处理不同类型的记录，避免了繁琐和易错的字节操作。
-   **服务接口**: 通过`DnsCache`和`RecordStore`等接口定义了服务契约，实现了模块间的低耦合。
-   **枚举推荐**: 对于协议中的常量值（如Opcode, RCode, Type），推荐使用Java枚举实现，以提高代码可读性和类型安全。

## 3. 消息解析与构建

消息的编解码是项目中最注重二进制细节的部分，由`MessageParser`和`MessageBuilder`负责。

-   **解码 (`MessageParser`)**:
    -   将网络字节流转换为`Message`对象。
    -   能够正确处理域名压缩指针。
    -   **核心职责**: 根据资源记录的`type`字段，将RDATA部分直接解析为对应的`RData`强类型对象（如将A记录的4字节数据解析为`AData`对象）。

-   **编码 (`MessageBuilder`)**:
    -   将`Message`对象转换为网络字节流。
    -   **核心职责**: 能够根据`RData`对象的具体类型，将其序列化为正确的字节格式。
    -   在编码域名时，将智能地使用指针压缩方案以优化输出大小。

## 4. DNS查询处理流程

查询流程由`RecursiveResolver`主导，遵循高效的解析算法：

1.  **缓存优先**: 收到请求后，首先检查缓存。如果命中（包括肯定和否定结果），则直接构建响应返回。
2.  **本地记录**: 缓存未命中时，查询本地记录存储（`dns.conf`），若找到则返回结果并缓存。
3.  **递归解析**: 若本地也无记录，则启动递归查询：
    -   从根服务器开始，迭代查询NS记录。
    -   在收到NS委托时，正确处理**胶水记录 (Glue Records)**。若附加区段包含NS服务器的IP，则直接使用；否则，发起子查询解析NS服务器的IP。
    -   正确处理`CNAME`记录链，并包含循环检测机制。
4.  **结果处理**: 获得最终答案或权威的"域名不存在"（NXDOMAIN）答复后，将其存入缓存，并构建格式正确的响应返回给客户端。

## 5. 本地记录存储

为了支持本地解析、域名屏蔽等功能，系统通过`ConfigFileRecordStore`从一个简化的配置文件`dns.conf`中加载记录。

-   **格式**: 采用`[域名] [TTL] [类别] [类型] [数据]`的简化格式，易于手动编辑。
-   **范围**: 该格式不支持`$ORIGIN`等标准ZoneFile的高级指令，其目标是简单易用。
-   **加载**: 服务启动时，解析`dns.conf`文件，将字符串数据转换为强类型的`ResourceRecord`（包含`RData`对象），并加载到内存中以便快速查找。支持通过接口进行动态重载。

## 6. 缓存实现

缓存是提升性能的关键，其设计兼顾了性能、线程安全和功能的完整性。

-   **数据结构**: 使用`ConcurrentHashMap`作为底层存储，保证高并发下的线程安全。
-   **`CacheEntry`**: 创建了一个包装类`CacheEntry`，它包含记录列表和一个绝对过期时间戳。
-   **肯定与否定缓存**: 通过向`CacheEntry`构造函数传递记录列表和显式的TTL，该设计能无缝支持：
    -   **肯定缓存**: 记录列表非空，TTL来自记录本身。
    -   **否定缓存**: 记录列表为空，TTL来自SOA记录。
-   **淘汰策略**: 采用**被动淘汰**（访问时检查TTL）和**主动清理**（后台线程定期扫描）相结合的策略，防止内存无限增长。

## 7. 错误处理与日志

健壮的错误处理和清晰的日志是服务稳定性的保障。

-   **异常分类**:
    -   **网络异常**: `IOException`等，通常是服务级故障。
    -   **协议异常**: `MalformedDnsPacketException`，解析格式错误的报文时抛出，向客户端返回`RCODE=1 (FORMERR)`。
    -   **解析异常**: `DnsResolutionException`，上游服务器无响应等，返回`RCODE=2 (SERVFAIL)`。
-   **接口设计**: 关键的`QueryCoordinator.handleQuery`方法签名包含`InetSocketAddress clientAddress`，确保在出错时能准确记录请求来源。
-   **正常与异常的区分**: 明确`RCODE=3 (NXDOMAIN)`是正常的业务逻辑结果，由解析器主动构建，而非通过捕获异常产生。
-   **日志系统**: 采用 **SLF4J + Logback** 的标准组合，并定义了从`TRACE`到`ERROR`的五级日志级别，确保在不同环境下都能获得所需的信息。

## 8. 性能优化策略

系统采用了一系列现代Java的最佳实践来保证低延迟和高吞吐。

1.  **异步网络I/O**: 使用`java.nio`的`Selector`模型，实现非阻塞I/O。
2.  **线程池隔离**: 将耗时的解析逻辑放入一个独立的业务线程池中执行，避免阻塞NIO网络线程。
3.  **内存优化**: 通过**对象池**（特别是`ByteBuffer`池）来复用高频创建和销毁的对象，显著降低GC压力。
4.  **GC调优**: 为生产环境推荐使用G1、ZGC等对低延迟更友好的垃圾收集器。
5.  **JIT预热**: 支持在服务启动后通过模拟请求进行JIT预热，使服务能快速进入最佳性能状态。

## 9. 测试策略

采用分层测试策略，确保代码质量和协议兼容性。

-   **单元测试**: 针对单个模块，如`MessageParser`，测试其对合法及**非法**报文的处理；测试`DnsCache`的过期和否定缓存逻辑。
-   **集成测试**: 验证多个组件的协同工作，如`RecursiveResolver`与`DnsCache`的交互。
-   **端到端测试**: 启动完整服务，使用`dig`等真实客户端验证关键场景，包括：
    -   CNAME记录链解析
    -   依赖胶水记录的解析
    -   上游服务器失败返回SERVFAIL
    -   负缓存的有效性
-   **性能测试**: 使用`dnsperf`等工具，在部署前对QPS、延迟和资源消耗进行基准测试。 